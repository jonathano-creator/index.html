<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo - Seguimiento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <!-- Usamos data-type="module" para que Babel entienda que debe usar imports de ES6 -->
    <script type="text/babel" data-type="module">
        // Importaciones de Firebase mediante módulos ESM
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const { useState, useEffect } = React;

        // --- CONFIGURACIÓN ---
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = window.__app_id || 'default-app-id';

        function App() {
            const [user, setUser] = useState(null);
            const [reportes, setReportes] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            // 1. Inicialización y Autenticación
            useEffect(() => {
                let auth;
                try {
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    
                    const initAuth = async () => {
                        try {
                            if (window.__initial_auth_token) {
                                await signInWithCustomToken(auth, window.__initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (err) {
                            console.error("Error Auth:", err);
                            setError("Error de autenticación: " + err.message);
                        }
                    };

                    initAuth();
                } catch (e) {
                    console.error("Error inicializando Firebase:", e);
                    setError("Error de configuración inicial.");
                }

                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                    } else {
                        setLoading(true);
                    }
                });
                return () => unsubscribe();
            }, []);

            // 2. Suscripción a la Base de Datos
            useEffect(() => {
                if (!user) return;

                const db = getFirestore();
                const collectionPath = collection(db, 'artifacts', appId, 'public', 'data', 'seguimiento_jovenes');
                const q = query(collectionPath);

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const docs = snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data() 
                    }));
                    
                    docs.sort((a, b) => {
                        const timeA = a.timestamp?.seconds || 0;
                        const timeB = b.timestamp?.seconds || 0;
                        return timeB - timeA;
                    });
                    
                    setReportes(docs);
                    setLoading(false);
                    setError(null);
                }, (err) => {
                    console.error("Error en Firestore:", err);
                    setError("Error de permisos o conexión al leer datos.");
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            });

            if (error) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen p-6 text-center">
                        <div className="bg-red-100 text-red-600 p-4 rounded-full mb-4">
                            <i data-lucide="alert-triangle" className="w-8 h-8"></i>
                        </div>
                        <h2 className="text-2xl font-bold mb-2">Error de Acceso</h2>
                        <p className="text-slate-600 mb-6 max-w-md">{error}</p>
                        <button 
                            onClick={() => window.location.reload()} 
                            className="px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-colors"
                        >
                            Reintentar
                        </button>
                    </div>
                );
            }

            if (loading && !user) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
                        <p className="text-slate-500 font-medium tracking-wide text-center">Iniciando panel administrativo...</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans">
                    <header className="max-w-6xl mx-auto mb-10 flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h1 className="text-4xl font-black text-slate-900 tracking-tight">Panel Administrativo</h1>
                            <p className="text-slate-500 font-medium">Gestión y control de reportes</p>
                        </div>
                        <div className="bg-white border border-slate-200 px-4 py-2 rounded-2xl flex items-center gap-3 shadow-sm self-start md:self-center">
                            <div className="w-2.5 h-2.5 bg-emerald-500 rounded-full animate-pulse"></div>
                            <span className="text-xs font-bold text-slate-600 uppercase tracking-wider">Conexión Activa</span>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto">
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
                            <div className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm flex items-center gap-5">
                                <div className="bg-indigo-50 p-4 rounded-2xl text-indigo-600">
                                    <i data-lucide="users" className="w-6 h-6"></i>
                                </div>
                                <div>
                                    <p className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-0.5">Total Reportes</p>
                                    <p className="text-3xl font-black text-slate-900">{reportes.length}</p>
                                </div>
                            </div>
                            
                            <div className="bg-indigo-600 p-6 rounded-[2rem] text-white shadow-lg shadow-indigo-100 flex items-center gap-5">
                                <div className="bg-white/20 p-4 rounded-2xl">
                                    <i data-lucide="lock" className="w-6 h-6"></i>
                                </div>
                                <div>
                                    <p className="text-indigo-100 text-xs font-bold uppercase tracking-widest mb-0.5">Estado</p>
                                    <p className="text-xl font-bold italic">Acceso Autorizado</p>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-[2.5rem] border border-slate-200 overflow-hidden shadow-sm">
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="bg-slate-50/50 border-b border-slate-100">
                                            <th className="px-8 py-5 text-xs font-bold text-slate-400 uppercase tracking-widest">Joven</th>
                                            <th className="px-8 py-5 text-xs font-bold text-slate-400 uppercase tracking-widest">Mentor</th>
                                            <th className="px-8 py-5 text-xs font-bold text-slate-400 uppercase tracking-widest text-center">Sentimiento</th>
                                            <th className="px-8 py-5 text-xs font-bold text-slate-400 uppercase tracking-widest">Fecha</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50">
                                        {reportes.length > 0 ? reportes.map(r => (
                                            <tr key={r.id} className="hover:bg-indigo-50/30 transition-colors group">
                                                <td className="px-8 py-5">
                                                    <div className="font-bold text-slate-800 text-lg group-hover:text-indigo-600 transition-colors">{r.nombreJoven}</div>
                                                </td>
                                                <td className="px-8 py-5">
                                                    <div className="text-slate-600 font-medium">{r.mentor}</div>
                                                </td>
                                                <td className="px-8 py-5 text-center">
                                                    <span className={`px-4 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-wider ${
                                                        r.sentimiento === 'Excelente' ? 'bg-emerald-100 text-emerald-700' :
                                                        r.sentimiento === 'Regular' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'
                                                    }`}>
                                                        {r.sentimiento || 'N/A'}
                                                    </span>
                                                </td>
                                                <td className="px-8 py-5">
                                                    <div className="text-sm text-slate-400 font-medium">
                                                        {r.timestamp?.seconds 
                                                            ? new Date(r.timestamp.seconds * 1000).toLocaleDateString('es-ES') 
                                                            : 'Reciente'}
                                                    </div>
                                                </td>
                                            </tr>
                                        )) : (
                                            <tr>
                                                <td colSpan="4" className="px-8 py-20 text-center text-slate-300">
                                                    No hay reportes disponibles.
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
